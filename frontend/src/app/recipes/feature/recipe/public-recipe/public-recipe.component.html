<div class="flex w-full flex-col items-center">
  <mat-spinner class="my-app-custom-spinner" *ngIf="!ready()"></mat-spinner>
  <div *ngIf="ready()">
    <img
      *ngIf="recipe().photoURL"
      [src]="recipe().photoURL"
      alt="Recipe Image"
      class="w-full object-cover"
    />
    <!-- Overview -->
    <div class="relative mx-dl-5 mb-dl-5 mt-dl-3 rounded-lg shadow-md">
      <div class="mx-dl-5 mb-dl-4 mt-dl-5 flex justify-between">
        <h1 class="text-dl-7 font-dl-3 leading-dl-2 text-dl-grey-1">
          {{ recipe().title }}
        </h1>
        <div class="" *ngIf="author()">
          <img
            *ngIf="author().imageURL"
            (click)="onFriendClick(author())"
            class="h-dl-5 w-dl-5 rounded-full"
            [src]="author().imageURL"
            alt="author profile image"
          />
          <span
            class="inline-flex h-dl-6 w-dl-6 items-center justify-center rounded-full bg-dl-grey-9"
            *ngIf="
              !author().imageURL && author().nameFirst && author().nameLast
            "
          >
            <span class="text-dl-6 font-dl-3 leading-none text-dl-grey-7">{{
              initials()
            }}</span>
          </span>
        </div>
      </div>
      <!-- Category, Servings , Subscriber Count-->
      <div class="mx-dl-5 mb-dl-5 flex items-center justify-between">
        <p class="ml-dl-1 text-dl-6 font-dl-2 leading-dl-2 text-dl-grey-2">
          {{ recipeCategory()?.name }}
        </p>
        <div class="flex pt-dl-2">
          <!--Servings-->
          <div class="relative flex">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              xmlns:xlink="http://www.w3.org/1999/xlink"
              version="1.1"
              height="35"
              width="35"
              viewBox="0 0 90 112.5"
              style="enable-background: new 0 0 90 90"
              xml:space="preserve"
            >
              <path
                [attr.fill]="'hsl(209, 14%, 37%)'"
                d="M87.4,14.5c0,0,1.6-1.8,0.9-2.5s-2.5,0.9-2.5,0.9S75.6,21.5,74,23.1l0,0c0,0-1.2,1.2-2.1,0.2c-1-1,0.2-2.1,0.2-2.1  c1.7-1.7,10.3-11.7,10.3-11.7S84,7.7,83.2,7c-0.7-0.7-2.5,0.9-2.5,0.9S70.7,16.5,69,18.1c0,0-1.2,1.2-2.1,0.2c-1-1,0.2-2.1,0.2-2.1  c1.7-1.7,10.3-11.7,10.3-11.7S79,2.7,78.3,2s-2.5,0.9-2.5,0.9S65.7,11.5,64,13.1c0,0-1.9,1.9-3.9,3.9l0,0L57,20.1  c-3,3-4.3,6.8-3.9,10.1c0,0,0,0,0,0c0.2,2.8-1.5,4.6-1.5,4.6L3,80.7c-0.1,0.1-0.2,0.2-0.3,0.3c-2.2,2.2-2.6,5.5-0.8,7.3  c1.8,1.8,5.1,1.5,7.3-0.8c0.1-0.1,0.2-0.2,0.3-0.3l45.8-48.6c0,0,1.8-1.8,4.6-1.6c0.1,0,0.2,0,0.3,0c3.2,0.3,6.9-1,9.8-3.9l2.8-2.8  l0.3-0.3c1.9-1.9,3.9-3.9,3.9-3.9C78.7,24.5,87.4,14.5,87.4,14.5z"
              />
            </svg>
            <span
              class="ml-dl-1 text-dl-6 font-dl-2 leading-dl-2 text-dl-grey-4"
              >{{ recipe().servings }}</span
            >
          </div>
          <!--Subscriber Count-->
          <div class="ml-dl-5 mr-dl-2 flex">
            <svg
              height="512"
              viewBox="0 0 24 24"
              width="512"
              xmlns="http://www.w3.org/2000/svg"
              id="fi_2118701"
              height="32"
              width="32"
              class=""
            >
              <path
                [attr.fill]="'hsl(209, 14%, 37%)'"
                d="m23 19a1 1 0 0 1 -1 1h-12a1 1 0 0 1 -1-1 6 6 0 0 1 6-6h2a6 6 0 0 1 6 6zm-7-15a4 4 0 1 0 4 4 4 4 0 0 0 -4-4zm-9 0a4 4 0 1 0 4 4 4 4 0 0 0 -4-4zm0 15a7.94 7.94 0 0 1 2.35-5.65 5.43 5.43 0 0 0 -1.91-.35h-.88a5.57 5.57 0 0 0 -5.56 5.56v.44a1 1 0 0 0 1 1h5.18a3 3 0 0 1 -.18-1z"
              ></path>
            </svg>
            <span
              class="ml-dl-1 text-dl-6 font-dl-2 leading-dl-2 text-dl-grey-4"
              >{{ subscriptions().length }}</span
            >
          </div>
        </div>
      </div>

      <!--Times -->
      <div class="mx-dl-5 mb-dl-6 flex items-center justify-between px-dl-1">
        <svg
          class="text-dl-grey-4"
          width="22"
          height="22"
          viewBox="0 0 15 15"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M7.50009 0.877014C3.84241 0.877014 0.877258 3.84216 0.877258 7.49984C0.877258 11.1575 3.8424 14.1227 7.50009 14.1227C11.1578 14.1227 14.1229 11.1575 14.1229 7.49984C14.1229 3.84216 11.1577 0.877014 7.50009 0.877014ZM1.82726 7.49984C1.82726 4.36683 4.36708 1.82701 7.50009 1.82701C10.6331 1.82701 13.1729 4.36683 13.1729 7.49984C13.1729 10.6328 10.6331 13.1727 7.50009 13.1727C4.36708 13.1727 1.82726 10.6328 1.82726 7.49984ZM8 4.50001C8 4.22387 7.77614 4.00001 7.5 4.00001C7.22386 4.00001 7 4.22387 7 4.50001V7.50001C7 7.63262 7.05268 7.7598 7.14645 7.85357L9.14645 9.85357C9.34171 10.0488 9.65829 10.0488 9.85355 9.85357C10.0488 9.65831 10.0488 9.34172 9.85355 9.14646L8 7.29291V4.50001Z"
            fill="currentColor"
            fill-rule="evenodd"
            clip-rule="evenodd"
          ></path>
        </svg>
        <p *ngIf="recipe().timePrep" class="text-dl-5 font-dl-2 text-dl-grey-4">
          Prep: {{ timeString(recipe().timePrep) }}
        </p>
        <p *ngIf="recipe().timeBake" class="text-dl-5 font-dl-2 text-dl-grey-4">
          Bake: {{ timeString(recipe().timeBake) }}
        </p>
        <p *ngIf="recipe().timeBake" class="text-dl-6 font-dl-3 text-dl-grey-3">
          Total:
          {{ timeString(recipe().timeBake + recipe().timePrep) }}
        </p>
      </div>

      <!-- Subscribe Section -->
      <div
        *ngIf="recipeSubscription()"
        class="mx-dl-5 mb-dl-5 flex items-center justify-between px-dl-1 pb-dl-5 pt-dl-1"
      >
        <p class="text-dl-5 font-dl-2 text-dl-grey-4">You are subscribed</p>
        <button
          type="button"
          class="block w-dl-9 whitespace-nowrap rounded-dl-1 border bg-dl-pink-4 px-dl-1 py-dl-1 text-center text-dl-5 font-dl-3 text-white shadow-sm transition-all duration-200 ease-in-out"
          (click)="onSubscribeClick()"
        >
          My Subscription
        </button>
      </div>

      <div
        *ngIf="!recipeSubscription()"
        class="mx-dl-5 mb-dl-5 flex items-center justify-between px-dl-1 pb-dl-5 pt-dl-1"
      >
        <p class="text-dl-5 font-dl-2 text-dl-grey-4">
          Subscribe to use this recipe
        </p>
        <button
          type="button"
          class="block whitespace-nowrap rounded-dl-1 border bg-dl-pink-4 px-dl-3 py-dl-1 text-center text-dl-5 font-dl-3 text-white shadow-sm transition-all duration-200 ease-in-out"
          (click)="onSubscribeClick()"
        >
          Subscribe
        </button>
      </div>
    </div>

    <!-- Ingredients -->
    <div
      *ngIf="displayIngredientsByComponent()"
      class="mx-dl-5 mt-dl-5 flex flex-col rounded-lg pb-dl-5 shadow-md"
    >
      <div class="flex justify-between">
        <p class="mb-dl-3 pl-dl-3 pt-dl-1 text-dl-7 font-dl-3 text-dl-grey-2">
          Ingredients
        </p>
      </div>
      <!-- Base Ingredients (no assigned component) -->
      <div
        *ngFor="let ingredient of displayIngredientsByComponent().noComponent"
        class="mt-dl-2 flex w-full justify-between"
      >
        <span class="min-w-dl-9 pl-dl-5 text-dl-6 font-dl-3 text-dl-grey-2">
          {{ ingredient.name }}
          <span
            *ngIf="ingredient.preparation"
            class="pl-dl-3 text-dl-5 font-dl-2 italic text-dl-grey-2"
          >
            {{ ingredient.preparation }}
          </span>
        </span>
        <div class="flex justify-end">
          <span class="ml-dl-1 mr-dl-3 text-dl-6 font-dl-2 text-dl-grey-3">
            {{ ingredient.measurement }}
          </span>
          <span class="min-w-dl-8 text-dl-6 font-dl-2 text-dl-grey-2">
            {{
              ingredient.measurementUnit === "weightOunces"
                ? "oz"
                : ingredient.measurementUnit
            }}
          </span>
        </div>
      </div>

      <!-- Ingredients for recipe components (ex: filling, sauce) -->
      <div
        *ngFor="
          let component of displayIngredientsByComponent().components | keyvalue
        "
        class="relative mt-dl-7"
      >
        <div>
          <!-- Italic Label with component name -->
          <span
            class="absolute -top-4 left-1/2 -translate-x-1/2 text-dl-6 font-dl-3 italic text-dl-grey-5"
            >for {{ component.key }}</span
          >

          <!-- Ingredients for component (display them same as in no-component) -->
          <div
            *ngFor="let ingredient of component.value"
            class="mt-dl-2 flex w-full justify-between"
          >
            <span class="min-w-dl-9 pl-dl-5 text-dl-6 font-dl-3 text-dl-grey-2">
              {{ ingredient.name }}
              <span
                *ngIf="ingredient.preparation"
                class="pl-dl-3 text-dl-5 font-dl-2 italic text-dl-grey-2"
              >
                {{ ingredient.preparation }}
              </span>
            </span>
            <div class="flex justify-end">
              <span class="ml-dl-1 mr-dl-3 text-dl-6 font-dl-2 text-dl-grey-3">
                {{ ingredient.measurement }}
              </span>
              <span class="min-w-dl-8 text-dl-6 font-dl-2 text-dl-grey-2">
                {{
                  ingredient.measurementUnit === "weightOunces"
                    ? "oz"
                    : ingredient.measurementUnit
                }}
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tools -->
    <div class="mx-dl-5 mt-dl-5 flex flex-col rounded-lg pb-dl-5 shadow-md">
      <div class="flex items-center justify-between">
        <p class="mb-dl-3 pl-dl-3 pt-dl-1 text-dl-7 font-dl-3 text-dl-grey-2">
          Tools
        </p>
      </div>
      <div
        *ngFor="let tool of tools()"
        class="mt-dl-2 flex w-full justify-between"
      >
        <span class="min-w-dl-9 pl-dl-5 text-dl-6 font-dl-3 text-dl-grey-2">
          {{ tool.name }}
        </span>
        <span
          *ngIf="tool.quantity > 0"
          class="mr-dl-7 text-dl-6 font-dl-2 text-dl-grey-3"
        >
          {{ tool.quantity }}
        </span>
      </div>
      <span
        *ngIf="!tools().length || tools()[0].quantity === -1"
        class="pl-dl-5 text-dl-6 font-dl-2 italic text-dl-grey-3"
      >
        None required
      </span>
    </div>

    <!-- Steps -->
    <div
      class="mx-dl-5 mb-dl-2 mt-dl-5 flex flex-col items-center rounded-lg pb-dl-5 shadow-md"
    >
      <div class="mb-dl-4 flex w-full justify-between">
        <p class="mb-dl-3 pl-dl-3 pt-dl-1 text-dl-7 font-dl-3 text-dl-grey-2">
          Steps
        </p>
      </div>
      <div
        *ngFor="let step of displaySteps(); let i = index"
        class="flex w-full flex-col items-center justify-center"
        [ngClass]="{
          'mb-dl-6': i !== steps().length - 1,
        }"
      >
        <div class="mb-dl-2 flex w-full items-start">
          <!-- Step number with consistent width and padding -->
          <div class="pl-dl-5 text-dl-6 font-dl-3 text-dl-grey-3">
            {{ i + 1 }})
          </div>
          <!-- Title taking the remaining width -->
          <div class="flex-1">
            <p
              class="ml-dl-2 mr-dl-6 overflow-hidden whitespace-normal text-dl-6 font-dl-3 italic text-dl-grey-3"
            >
              {{ step.title }}
            </p>
          </div>
        </div>
        <!-- Step Description -->
        <p
          class="my-dl-1 w-full px-dl-5 text-left text-dl-5 font-dl-2 text-dl-grey-4"
          style="text-indent: 20px; text-align: justify"
        >
          {{ step.description }}
        </p>
        <!-- Step photo -->
        <img
          *ngIf="step.photoURL"
          [src]="step.photoURL"
          class="mt-dl-2 w-4/5 object-cover"
        />
      </div>
    </div>
  </div>
</div>
